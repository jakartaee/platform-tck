<?xml version="1.0"?>
<!--

    Copyright (c) 2018, 2021 Oracle and/or its affiliates. All rights reserved.

    This program and the accompanying materials are made available under the
    terms of the Eclipse Public License v. 2.0, which is available at
    http://www.eclipse.org/legal/epl-2.0.

    This Source Code may also be made available under the following Secondary
    Licenses when the conditions for such availability set forth in the
    Eclipse Public License v. 2.0 are satisfied: GNU General Public License,
    version 2 with the GNU Classpath Exception, which is available at
    https://www.gnu.org/software/classpath/license.html.

    SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0

-->

<project name="jwscommon" >

    <import file="../../../../../../../../bin/xml/ts.import.xml"/>

    <property name="vehicle.pkg.dir" value="com/sun/ts/tests/common/vehicle"/>

    <property name="jws.common.classes" value="
    com/sun/ts/tests/jws/utils/*.class,
    com/sun/ts/tests/jws/common/*.class"/>

    <property name="common.classes.all" value="
    ${jws.common.classes}"/>

    <property name="portable.classes" value="
    ${pkg.dir}/**/*.class"/>

    <property name="client.classes" value="
    ${pkg.dir}/**/*lient*.class"/>

    <property name="wsdl.xsd.files" value="
    **/*.wsdl, **/*.xsd"/>

    <property name="jaxws.runtime.xml" value="sun-jaxws.xml"/>

    <property name="GENERATED_CLASSES" value="${class.dir}/${pkg.dir}/generated_classes"/>
    <property name="GENERATED_SRC" value="${class.dir}/${pkg.dir}/generated_sources"/>

    <target name="jws.dependency.checks"> 
       <condition property="standalone.mode">
            <or>
               <contains substring="standalone" string="${platform.mode}"/>
               <contains substring="standalone" string="${the.vehicles}"/>
            </or>
       </condition>
       <!-- other check would also go here -->
       <condition property="ok.copy.templates.dd.files">
           <and>
               <not>
                   <contains substring="true" string="${standalone.mode}"/>
               </not>
               <not>
                   <contains substring="true" string="${dd.files.already.exist}"/>
               </not>
           </and>
       </condition>
       <condition property="ok.copy.no.dd.files">
           <and>
               <not>
                   <isset property="standalone.mode"/>
               </not>
               <contains substring="none" string="${which.dds}"/>
           </and>
       </condition>
       <condition property="include.standalone.listener.classes">
           <contains substring="true" string="${standalone.mode}"/>
       </condition>
       <echo message="standalone.mode=${standalone.mode}"/>
       <echo message="ok.copy.templates.dd.files=${ok.copy.templates.dd.files}"/>
       <echo message="ok.copy.no.dd.files=${ok.copy.no.dd.files}"/>
       <echo message="include.standalone.listener.classes=${include.standalone.listener.classes}"/>
    </target>

    <target name="set_listener_classes" depends="jws.dependency.checks" if="include.standalone.listener.classes">
       <property name="standalone.listener.classes" value="
         com.sun.ts.tests.jws.common.WSServlet,
         com/sun/ts/tests/jws/common/WSServletContextListener.class"/>
    </target>


    <macrodef name="which.token.file">
        <sequential>
          <if>
              <available file="${ts.home}/src/${pkg.dir}/${platform.mode}.tokens"/>
          <then>
              <property name="filter.file" value="${ts.home}/src/${pkg.dir}/${platform.mode}.tokens"/>
              <echo message="Using filter file:${filter.file}"/>
              <filterset id="token.replacements">
                   <filtersfile file="${filter.file}"/>
              </filterset>
          </then>
          <else>
              <property name="filter.file" value="${ts.home}/src/com/sun/ts/tests/jws/common/xml/${platform.mode}.tokens"/>
              <echo message="Using filter file:${filter.file}"/>
              <filterset id="token.replacements">
                   <filtersfile file="${filter.file}"/>
              </filterset>
          </else>
          </if>
        </sequential>
    </macrodef>

    <target name="copy_client_dd_files" depends="jws.dependency.checks" if="ok.copy.templates.dd.files">
        <which.token.file/>
        <!-- copy all template files that begin with appname to their appropriate name-->
        <for list="${the.vehicles}" param="vehicle" delimiter=" " trim="true">
          <sequential>
             <echo message="vehicle=@{vehicle}"/>
             <copy failonerror="false" overwrite="true" todir="${ts.home}/tmp">
               <fileset dir="${ts.home}/src/com/sun/ts/tests/jws/common/xml/deploymentDescriptors/templates"
                 includes="APPNAME_@{vehicle}*xml"/>
               <regexpmapper from="^APPNAME([\.|_])(.*)(xml)$$" to="${app.name}\1\2\3"/>
               <filterset>
                   <filter token="APPNAME" value="${app.name}_web"/>
                   <filter token="JNDINAME" value="${app.name}"/>
                   <filterset refid="token.replacements"/>
               </filterset>
             </copy>
          </sequential>
        </for>
        <!-- override a specific dd file that has already been created -->
        <if>
             <isset property="override.dd.files"/>
        <then>
             <echo message="Overriding the following dd files:${override.dd.files}"/>
             <copy failonerror="false" overwrite="true" todir="${ts.home}/tmp">
               <fileset dir="${current.dir}"
                 includes="${override.dd.files}"/>
             </copy>
        </then>
        </if>
      
    </target>

    <target name="copy_endpoint_dd_files" depends="jws.dependency.checks" if="ok.copy.templates.dd.files">
        <which.token.file/>
             <copy failonerror="false" overwrite="true" todir="${ts.home}/tmp">
               <fileset dir="${ts.home}/src/com/sun/ts/tests/jws/common/xml/deploymentDescriptors/templates"
                 includes="APPNAME.ear.sun-application.xml,
                           APPNAME_web.war.sun-web.xml"/>
               <regexpmapper from="^APPNAME([\.|_])(.*)(xml)$$" to="${app.name}\1\2\3"/>
               <filterset>
                   <filter token="APPNAME" value="${app.name}_web"/>
                   <filterset refid="token.replacements"/>
               </filterset>

             </copy>
    </target>

    <target name="annotate_vehicles" depends="jws.dependency.checks" unless="standalone.mode">
       <which.token.file/>
       <for list="${the.vehicles}" param="vehicle" delimiter=" " trim="true">
          <sequential>
            <echo message="creating annotated vehicle files for @{vehicle} vehicle"/>
            <ant antfile="build.xml" dir="${ts.home}/src/${vehicle.pkg.dir}/@{vehicle}" target="build">
               <property name="the.filter.file" value="${filter.file}"/>
            </ant>
          </sequential>
       </for>
    </target>


    <!-- default value for customization file name unless overridden by test -->
    <property name="customization.binding.files" value="customfile.xml" />

    <!-- list of customization files excluded from being processed by tools -->
    <property name="excluded.customization.binding.files" value="" />

     <!-- default value for generation of WSDL for wsgen invocations -->
    <property name="genwsdl" value="true" />

    <!-- default value for extension is (false) -->
    <property name="extension" value="false" />

    <!-- property constants for soap1.1 and soap1.2 protocols -->
    <property name="soap11" value="soap1.1" />
    <property name="soap12" value="Xsoap1.2" />

    <!-- default value for protocol is (soap1.1) -->
    <property name="protocol" value="${soap11}" />

    <!-- default value for endpoint.type is (servlet) -->
    <property name="endpoint.type" value="servlet" />

    <!-- determine if this is an ejb or servlet(default) based endpoint -->
    <macrodef name="set.endpoint.type">
        <sequential>
            <if>
                  <isset property="endpoint.type"/>
            <then>
               <!-- is this an ejb based endpoint -->
               <if>
                   <contains substring="ejb" string="${endpoint.type}"/>
               <then>
                   <var name="inf.wsdl.location" value="META-INF/wsdl"/>
               </then>
               <else>
                  <!-- the default is servlet based endpoint -->
                  <var name="inf.wsdl.location" value="WEB-INF/wsdl"/>
               </else>
               </if>
           </then>
           <else>
              <!-- the default is servlet based endpoint -->
              <echo message="using default value for endpoint.type"/>
              <var name="inf.wsdl.location" value="WEB-INF/wsdl"/>
           </else>
           </if>
           <echo message="inf.wsdl.location=${inf.wsdl.location}"/>
        </sequential>
    </macrodef>
    <!-- set the value that will be put into the sei wsdlLocation attribute of the @WebServiceRef -->
    <macrodef name="set.generationtime.endpoint.wsdl.location">
        <sequential>
            <if>
                  <isset property="wsdl.location"/>
            <then>
               <!-- if it is set, then use it -->
               <echo message="wsdl.location already set, using it"/>
               <var name="tmp.wsdl.location" value="${wsdl.location}"/>
            </then>
            <elseif>
                <contains substring="standalone" string="${platform.mode}"/>
            <then>
               <set.endpoint.type/>
               <var name="tmp.wsdl.location" value="${inf.wsdl.location}/${wsdl.filename}"/>
            </then>
            </elseif>
            <elseif>
                <not>
                   <contains substring="standalone" string="${platform.mode}"/>
                </not>
            <then>
                <var name="tmp.wsdl.location" value="@wsdlLocation@"/>
            </then>
            </elseif>
            </if>
            <echo message="tmp.wsdl.location=${tmp.wsdl.location}"/>
        </sequential>
    </macrodef>

    <macrodef name="set.endpoint.wsdl.location">
        <sequential>
            <if>
                  <isset property="wsdl.location"/>
            <then>
               <!-- if it is set, then use it -->
               <echo message="wsdl.location already set, using it"/>
               <var name="tmp.wsdl.location" value="${wsdl.location}"/>
            </then>
            <else>
               <set.endpoint.type/>
               <var name="tmp.wsdl.location" value="${inf.wsdl.location}/${wsdl.filename}"/>
            </else>
            </if>
            <echo message="tmp.wsdl.location=${tmp.wsdl.location}"/>
        </sequential>
    </macrodef>

    <!-- determine if this is an ejb or servlet(default) based endpoint -->
    <macrodef name="set.clientvehicle.type">
        <sequential>
            <echo message="the.vehicle=${the.vehicle}"/>
            <if>
                  <isset property="the.vehicle"/>
            <then>
               <!-- is this an ejb or appclient vehicle -->
               <if>
                 <or>
                   <contains substring="ejb" string="${the.vehicle}"/>
                   <contains substring="appclient" string="${the.vehicle}"/>
                 </or>
               <then>
                   <var name="inf.wsdl.location" value="META-INF/wsdl"/>
               </then>
               <else>
                  <var name="inf.wsdl.location" value="WEB-INF/wsdl"/>
               </else>
               </if>
           </then>
           <else>
              <!-- the default is servlet vehicle -->
              <echo message="using default value for vehicle"/>
              <var name="inf.wsdl.location" value="WEB-INF/wsdl"/>
           </else>
           </if>
           <echo message="inf.wsdl.location=${inf.wsdl.location}"/>
        </sequential>
    </macrodef>
    <!-- set the value that will be put into the sei wsdlLocation attribute of the @WebServiceRef -->
    <macrodef name="set.clientvehicle.wsdl.location">
        <sequential>
            <if>
                  <isset property="wsdl.location"/>
            <then>
               <!-- if it is set, then use it -->
               <echo message="wsdl.location already set, using it"/>
               <var name="tmp.wsdl.location" value="${wsdl.location}"/>
            </then>
            <else>
               <set.clientvehicle.type/>
               <var name="tmp.wsdl.location" value="${inf.wsdl.location}/${wsdl.filename}"/>
            </else>
            </if>
            <echo message="tmp.wsdl.location=${tmp.wsdl.location}"/>
        </sequential>
    </macrodef>

    <!-- create the sei and gsi class files that have the correct endpoint wsdl location -->
    <macrodef name="createEndpointSEIGSI">
        <sequential>
          <set.endpoint.wsdl.location/>
          <if>
              <and>
                 <not>
                   <contains substring="standalone" string="${platform.mode}"/>
                 </not>
                 <not>
                    <isset property="wsdl.location"/>
                 </not>
              </and>
          <then>
             <echo message="Correcting the wsdl location for the endpoint in the SEI and GSI"/>
             <echo message="The wsdl location will be set to:${tmp.wsdl.location}"/>
             <echo message="The vehicle is: ${the.vehicle}"/>
             <createSEIGSI/>
          </then>
          </if>
        </sequential>
    </macrodef>

    <!-- create the sei and gsi class files that have the correct client side wsdl location -->
    <macrodef name="createClientVehicleSEIGSI">
        <sequential>
          <set.clientvehicle.wsdl.location/>
          <echo message="platform.mode=${platform.mode}"/>
          <echo message="wsdl.location=${wsdl.location}"/>
          <echo message="the.vehicle=${the.vehicle}"/>
          <echo message="the.vehicles=${the.vehicles}"/>
          <if>
             <and>
                 <not>
                   <contains substring="standalone" string="${platform.mode}"/>
                 </not>
                 <not>
                   <isset property="wsdl.location"/>
                 </not>
                 <contains substring="${the.vehicle}" string="${the.vehicles}"/>
             </and>
           <then>
             <echo message="Correcting the wsdl location for the ${the.vehicle} vehicle in the SEI and GSI"/>
             <echo message="The wsdl location will be set to:${tmp.wsdl.location}"/>
             <createSEIGSI/>
           </then>
           <else>
             <echo message="No correction of the wsdl location for the ${the.vehicle} vehicle will take place"/>
           </else>
           </if>
        </sequential>
    </macrodef>

    <macrodef name="createSEIGSI">
        <sequential>
             <if>
                 <isset property="dependency.pkg"/>
             <then> 
                 <var name="tmp.pkg.dir" value="${dependency.pkg}"/>
             </then> 
             <else> 
                 <var name="tmp.pkg.dir" value="${pkg.dir}"/>
             </else> 
             </if>

             <!-- build the list of sei and gsi files -->
             <var name="cnt" value="1"/>
             <for list="${service.names}" param="service" delimiter="," trim="true">
               <sequential>
                 <var name="service.java.files" value=""/>
                 <var name="service.pkg.java.files" value=""/>
                 <var name="service.class.files" value=""/>

                 <var name="service.java.files" value="${service.java.files} @{service}.java"/>
                 <var name="service.pkg.java.files" value="${service.pkg.java.files} ${pkg.dir}/@{service}.java"/>
                 <var name="service.class.files" value="${service.class.files} @{service}.class"/>

                 <var name="sei.java.files" value=""/>
                 <var name="sei.pkg.java.files" value=""/>
                 <var name="sei.class.files" value=""/>
                 <propertyindex from="sei.names" name="_sei.names.tmp" delimiter=":" index="${cnt}"/>
                 <for list="${_sei.names.tmp}" param="sei" delimiter="," trim="true">
                   <sequential>
                     <var name="sei.java.files" value="${sei.java.files} @{sei}.java"/>
                     <var name="sei.pkg.java.files" value="${sei.pkg.java.files} ${pkg.dir}/@{sei}.java"/>
                     <var name="sei.class.files" value="${sei.class.files} @{sei}.class"/>
                   </sequential>
                 </for>

                 <echo message="service.java.files=${service.java.files}"/>
                 <echo message="service.pkg.java.files=${service.pkg.java.files}"/>
                 <echo message="service.class.files=${service.class.files}"/>
                 <echo message="sei.java.files=${sei.java.files}"/>
                 <echo message="sei.pkg.java.files=${sei.pkg.java.files}"/>
                 <echo message="sei.class.files=${sei.class.files}"/>

                  <echo message="copying the SEI and GSI sources to ${tmp.pkg.dir}"/>
                  <mkdir dir="${src.dir}/${pkg.dir}/${the.vehicle}"/>
                  <copy failonerror="false" overwrite="true" todir="${src.dir}/${pkg.dir}/${the.vehicle}">
                     <fileset dir="${class.dir}/${tmp.pkg.dir}/generated_sources/${tmp.pkg.dir}"
                       includes="${service.java.files} ${sei.java.files}"/>
                       <filterset>
                           <filter token="wsdlLocation" value="${tmp.wsdl.location}"/>
                       </filterset>
                  </copy>

                 <echo message="compiling the newly filtered SEI and GSI sources"/>
                 <echo message="SEI=(${sei.java.files})"/>
                 <echo message="GSI=(${service.java.files})"/>
                 <ts.javac includes="${pkg.dir}/${the.vehicle}/*.java"/>
                 <math result="cnt" operand1="${cnt}" operation="+" operand2="1" datatype="int" />
               </sequential>
             </for>
        </sequential>
    </macrodef>

    <macrodef name="removeSEIGSIsources">
        <sequential>
             <echo message="removing the new SEI and GSI sources for vehicle: ${the.vehicle}"/>
             <!-- COMMENT THE FOLLOWING LINE OUT TO RETAIN THE FILES -->
             <delete failonerror="false" dir="${src.dir}/${pkg.dir}/${the.vehicle}"/>
        </sequential>
    </macrodef>

    <!-- generates portable artifacts for WSDL-to-Java -->
    <macrodef name="do_wsimport">
        <sequential>
           <setup_target_dirs/>
           <echo message="wsdlFile=${wsdl.file}"/>
           <echo message="class.dir=${class.dir}/${pkg.dir}"/>
           <if>
               <!-- Ultimately we want to verify that if the wsdl has been updated then we need
                    to regenerate. We are using reverse logic here so that we can check the wsdl
                    against all the class files, since uptodate only allows the includes on the 
                    srcfiles side, or if the test directory wants the generation to occur regardless
                    of the timestamp by use of the always.generate property. 
                    The use of always.generate can use use in cases when a java class has 
                    been compiled before the wsimport task is called. In this case if always.generate
                    isn't used, then generation won't occur since there is a class file that is already
                    up todate. An example is src/com/sun/ts/tests/jaxws/wsi/w2j/rpc/literal/R1005 -->
               <or>
                   <not>
                       <available file="${wsdl.file}"/>
                   </not>                   
                   <uptodate targetfile="${wsdl.file}">
                      <srcfiles dir= "${class.dir}/${pkg.dir}" includes="*.class"/>
                   </uptodate>
                   <isset property="always.generate"/>
               </or>
      
          <then>
               <var name="wsdl.filename" value="${the.wsdl.filename}" />
               <set.generationtime.endpoint.wsdl.location/>
               <var name="_src.pkg.dir" value="${src.dir}/${pkg.dir}" />
               <var name="_pkg.dir.gensrc" value="${GENERATED_SRC}" />
               <var name="_pkg.dir.genclasses" value="${GENERATED_CLASSES}" />
               <mkdir dir="${_pkg.dir.gensrc}" />
               <mkdir dir="${_pkg.dir.genclasses}" />
               <translatepath propname="_src.pkg.dir" />
               <translatepath propname="_pkg.dir.gensrc" />
               <translatepath propname="_pkg.dir.genclasses" />
               <echo message="pkg.dir=${pkg.dir}"/>
               <echo message="_src.pkg.dir=${_src.pkg.dir}"/>
               <echo message="current.dir=${src.dir}/${pkg.dir}"/>
               <echo message="wsdlLocation=${wsdl.location}"/>
               <echo message="tmp.wsdl.location=${tmp.wsdl.location}"/>
               <echo message="binding files=${customization.binding.files}" />
               <echo message="excluded binding files=${excluded.customization.binding.files}" />
               <echo message="build.vi=${build.vi}"/>

               <if>
                   <istrue value="${build.vi}"/>
               <then>
                  <echo message="----------------------------------------------------------"/>
                  <echo message="Doing WSDL-to-Java generation using vendor specific tools"/>
                  <echo message="----------------------------------------------------------"/>
                  <!-- task definition for the Vendors ant task which inturn calls their WSDL-to-Java tool -->
                   <taskdef name="vi_wsimport" classname="${wsimport.ant.classname}">
                       <classpath>
                           <pathelement path="${wsimport.classpath}" />
                       </classpath>
                   </taskdef>
                   <vi_wsimport
                      fork="true"
                      verbose="${vi.wsimport.verbose}"
                      debug="${vi.wsimport.debug}"
                      destdir="${_pkg.dir.genclasses}"
                      sourcedestdir="${_pkg.dir.gensrc}"
                      keep="true"
                      package="${package}"
                      extension="${extension}"
                      wsdllocation="${tmp.wsdl.location}"
                      catalog="${ts.home}/bin/catalog/META-INF/jax-ws-catalog.xml"
                      wsdl="${wsdl.file}">
                      <binding dir="${_src.pkg.dir}" includes="${customization.binding.files}" excludes="${excluded.customization.binding.files}"/>
 		           <jvmarg line="${wsimport.jvmargs} "/>
                   </vi_wsimport>
               </then>
               <else>
                  <echo message="----------------------------------------------------------"/>
                  <echo message="Doing WSDL-to-Java generation using the SUN specific tools"/>
                  <echo message="----------------------------------------------------------"/>
                  <!-- task definition for the Sun's ant task which inturn calls the WSDL-to-Java tool -->
                   <taskdef name="ri_wsimport" classname="${ri.wsimport.ant.classname}">
                       <classpath>
                           <pathelement path="${ri.wsimport.classpath}" />
                       </classpath>
                   </taskdef>
                   <ri_wsimport
                     fork="true"
                     verbose="${ri.wsimport.verbose}"
                     debug="${ri.wsimport.debug}"
                     destdir="${_pkg.dir.genclasses}"
                     sourcedestdir="${_pkg.dir.gensrc}"
                     keep="true"
                     package="${package}"
                     extension="${extension}"
                     wsdllocation="${tmp.wsdl.location}" 
                     catalog="${ts.home}/bin/catalog/META-INF/jax-ws-catalog.xml"
                     wsdl="${wsdl.file}">
                     <binding dir="${_src.pkg.dir}" includes="${customization.binding.files}" excludes="${excluded.customization.binding.files}"/>
		             <jvmarg line="${ri.wsimport.jvmargs} "/>
                   </ri_wsimport>
               </else>
               </if>
           </then>
           <else>
              <echo message="WSImport: No generation is necessary, files are up to date"/>
           </else>
           </if>
        </sequential>
    </macrodef> 

<!-- generates portable artifacts for Java-to-WSDL -->
    <macrodef name="do_wsgen">
        <sequential>
           <setup_target_dirs/>
           <echo message="wsdlFile=${wsdl.file}"/>
           <echo message="impl=${impl.class}" />
           <propertyregex property="_impl.class"
              input="${impl.class}"
              regexp="(\.)"
              replace="\/"
              casesensitive="false" 
              global="true"/>
           <echo message="_impl=${_impl.class}" />
           <echo message="_impl2=${class.dir}/${_impl.class}.class" />
           <if>
               <!-- Ultimately we want to verify that if the classes have been updated then we need
                    to regenerate. We are using reverse logic here so that we can check the class files
                    against the wsdl file, since uptodate only allows the includes on the 
                    srcfiles side, or if the test directory wants the generation to occur regardless
                    of the timestamp by use of the always.generate property -->
                <or>
                   <uptodate targetfile="${class.dir}/${_impl.class}.class">
                      <srcfiles file="${wsdl.file}"/>
                   </uptodate>
                   <isset property="always.generate"/>
               </or>
          <then>
               <property name="_pkg.dir" value="${ts.home}/src/${pkg.dir}" />
               <property name="_pkg.dir.gensrc" value="${GENERATED_SRC}" />
               <property name="_pkg.dir.genclasses" value="${GENERATED_CLASSES}" />
               <translatepath propname="_pkg.dir" />
               <translatepath propname="_pkg.dir.gensrc" />
               <translatepath propname="_pkg.dir.genclasses" />
               <mkdir dir="${_pkg.dir.gensrc}"/>
               <mkdir dir="${_pkg.dir.genclasses}"/>
               <property name="_classpath" value="${wsgen.classpath}:${class.dir}:${_pkg.dir}"/>
               <translatepath propname="_classpath" />
               <echo message="build.vi=${build.vi}"/>
               <if>
                   <istrue value="${build.vi}"/>
               <then>
                    <echo message="----------------------------------------------------------"/>
                    <echo message="Doing Java-to-WSDL generation using vendor specific tools"/>
                    <echo message="----------------------------------------------------------"/>
                    <!-- task definition for the Vendors task which inturn calls their Java-to-WSDL tool -->
                   <taskdef name="vi_wsgen" classname="${wsgen.ant.classname}">
                       <classpath>
                           <pathelement path="${wsgen.classpath}" />
                       </classpath>
                   </taskdef>
                    <vi_wsgen
                      fork="true"
                      debug="${vi.wsgen.debug}"
                      keep="true"
                      destdir="${_pkg.dir.genclasses}"
                      resourcedestdir="${_pkg.dir}"
                      verbose="${vi.wsgen.verbose}"
                      classpath="${_classpath}"
                      sei="${impl.class}"
                      genwsdl="${genwsdl}"
                      extension="${extension}"
                      protocol="${protocol}"
                      sourcedestdir="${_pkg.dir.gensrc}">
                      <classpath>
                         <pathelement path="${_classpath}" />
                      </classpath>
 		              <jvmarg line=""/>
                    </vi_wsgen>
                </then>
               <else>
                    <echo message="----------------------------------------------------------"/>
                    <echo message="Doing Java-to-WSDL generation using the SUN specific tools"/>
                    <echo message="----------------------------------------------------------"/>
                    <!-- task definition for the Vendors task which inturn calls their Java-to-WSDL tool -->
                    <taskdef name="ri_wsgen" classname="${ri.wsgen.ant.classname}">
                       <classpath>
                           <pathelement path="${ri.wsgen.classpath}" />
                       </classpath>
                    </taskdef>
                    <ri_wsgen
                        fork="true"
                        debug="${ri.wsgen.debug}"
                        keep="true"
                        destdir="${_pkg.dir.genclasses}"
                        resourcedestdir="${_pkg.dir}"
                        verbose="${ri.wsgen.verbose}"
                        classpath="${_classpath}"
                        sei="${impl.class}"
                        genwsdl="${genwsdl}"
                        extension="${extension}"
                        protocol="${protocol}"
                        sourcedestdir="${_pkg.dir.gensrc}">
                        <classpath>
                            <pathelement path="${_classpath}" />
                        </classpath>
                        <jvmarg line=""/>
                    </ri_wsgen>
               </else>
               </if>
           </then>
           <else>
              <echo message="WSGen: No generation is necessary, files are up to date"/>
           </else>
           </if>
        </sequential>
    </macrodef>


    <!-- creates initial directories used during generation process -->
    <macrodef  name="add_generated_class_dir">
        <sequential>
           <mkdir dir="${GENERATED_CLASSES}" />
           <mkdir dir="${GENERATED_SRC}" />
        </sequential>
    </macrodef>

    <!-- re-initializes the directories used during repetitive generation process -->
    <macrodef name="setup_target_dirs" >
        <sequential>
            <add_generated_class_dir/>
            <if>
                <istrue value="${no.setup}"/>
            <then>
                <!-- nothing to do, we don't want to do setup -->
            </then>
            <else>
               <mkdir dir="${GENERATED_CLASSES}" />
               <mkdir dir="${GENERATED_SRC}" />
            </else>
            </if>
        </sequential>
    </macrodef>

    <!-- moves the generated classes to the package class directory for the test -->
    <macrodef name="move_generated_artifacts">
        <sequential>
           <move todir="${class.dir}">
               <fileset dir="${GENERATED_CLASSES}" includes="**/*.class, **/*.xml"/>
           </move>
           <delete_generated_classes/>
        </sequential>
    </macrodef>

    <!-- deletes the generated classes -->
    <macrodef name="delete_generated_classes">
        <sequential>
           <delete failonerror="false">
               <fileset dir="${GENERATED_CLASSES}" includes="**/*" />
           </delete>
        </sequential>
    </macrodef>

    <!-- Copies the wsdl and xsd files from the corresponding dependency directory -->
    <macrodef name="copy_wsdl_xsd_from_dependency_dir">
        <attribute name="dir" default="${dependency.dir}" />
        <sequential>
           <echo message="copying wsdl and xsd from dependency directory"/>
           <copy todir="${src.dir}/${pkg.dir}" failonerror="true">
               <fileset dir="@{dir}" includes="**/*.wsdl, **/*.xsd" />
           </copy>
        </sequential>
    </macrodef>

    <!-- removes WSDL and XSD files from the src directory -->
    <macrodef name="remove_wsdl_xsd">
        <sequential>
           <delete failonerror="false">
               <fileset dir="${src.dir}/${pkg.dir}" includes="${wsdl.xsd.files}" />
           </delete>
        </sequential>
    </macrodef>

    <!-- removes WSDL and XSD files from the dependency directory -->
    <macrodef name="remove_wsdl_xsd_from_dependency_dir">
        <sequential>
           <delete failonerror="false">
               <fileset dir="${dependency.dir}" includes="${wsdl.xsd.files}" />
           </delete>
        </sequential>
    </macrodef>

    <!-- starts from a client only directory and removes the wsdl and xsd files -->
    <!-- copied from the corresponding server directory -->
    <macrodef name="remove_copied_wsdl_xsd">
        <sequential>
            <if>
                <isset property="dependency.dir"/>
            <then>
                <remove_wsdl_xsd/>
            </then>
            </if>
        </sequential>
    </macrodef>


    <!-- copy the platform specific runtime file -->
    <macrodef name="copy_runtime_file">
        <sequential>
           <copy failonerror="false" overwrite="true" file="${ts.home}/src/${pkg.dir}/${platform.mode}-${jaxws.runtime.xml}" tofile="${ts.home}/src/${pkg.dir}/${jaxws.runtime.xml}"/>
        </sequential>
    </macrodef>

    <!-- removes the platform specific runtime file -->
    <macrodef name="remove_runtime_file">
        <sequential>
           <delete failonerror="false">
               <fileset dir="${ts.home}/src/${pkg.dir}" includes="sun-jaxws.xml" />
           </delete>
        </sequential>
    </macrodef>

    <!-- copies the platform specific webxml file to web.xml -->
    <target name="copy_webxml_file" depends="set_listener_classes">
       <which.token.file/>
       <copy file="${ts.home}/src/${pkg.dir}/${platform.mode}.web.xml" tofile="${ts.home}/src/${pkg.dir}/web.xml" overwrite="true" >
           <filterset>
              <filterset refid="token.replacements"/>
              <filter token="JNDINAME" value="${app.name}"/>
           </filterset>
       </copy>
    </target>

    <!-- removes the copied web.xml file -->
    <macrodef name="remove_webxml_file">
        <sequential>
           <delete failonerror="false">
               <fileset dir="${ts.home}/src/${pkg.dir}" includes="web.xml" />
           </delete>
           <delete failonerror="false">
               <fileset dir="${ts.home}/src/${pkg.dir}" includes="webservices.xml" />
           </delete>
           <delete failonerror="false">
               <fileset dir="${ts.home}/src/${pkg.dir}" includes="sun-web.xml" />
           </delete>
        </sequential>
    </macrodef>

    <!-- WSDL-to-Java generation of portable artifacts (intermediate step) -->
    <!-- populates WEB-INF, WEB-INF/wsdl with appropriate artifacts -->
    <target name="do_wsdl2java_generate">
        <do_wsimport/>
        <copy_runtime_file/>
    </target>

    <!-- WSDL-to-Java generation of portable artifacts for server for inclusion within WAR -->
    <!-- populates WEB-INF, WEB-INF/wsdl, WEB-INF/lib with appropriate artifacts -->
    <target name="do_wsdl2java_generate_server" >
        <antcall target="do_wsdl2java_generate"/>
        <move_generated_artifacts/>
    </target>

    <!-- WSDL-to-Java generation of portable artifacts for client -->
    <target name="do_wsdl2java_generate_client">
        <do_wsimport/>
        <move_generated_artifacts/>
    </target>

    <!-- Java-to-WSDL generation of portable artifacts for client -->
    <target name="do_java2wsdl_generate_client">
        <do_wsgen/>
        <move_generated_artifacts/>
    </target>

    <!-- Java-to-WSDL generation of portable artifacts for server for inclusion within WAR -->
    <!-- populates WEB-INF, WEB-INF/lib with appropriate artifacts -->
    <target name="do_java2wsdl_generate_server" >
        <do_wsgen/>
        <copy_runtime_file/>
        <move_generated_artifacts/>
    </target>

<!-- ==========================================================
     These are all the packaging targets
     ========================================================== -->

  <target name="j2w_webservice_import_package" depends="copy_webxml_file">
    <var name="the.vehicle" value="endpoint"/>
    <createEndpointSEIGSI/>
    <antcall target="copy_endpoint_dd_files" />
    <ts.war archivename="${app.name}" descriptor="web.xml">
         <zipfileset dir="${class.dir}" includes="${impl.classes}, 
                                                  ${portable.classes}, 
                                                  ${other.classes}, 
                                                  ${jws.common.classes}" 
                                        excludes="${client.classes}" prefix="WEB-INF/classes"/>
	    <zipfileset dir="${src.dir}/${pkg.dir}" includes="${wsdl.xsd.files}" prefix="WEB-INF/wsdl" />
         <zipfileset dir="${src.dir}/${pkg.dir}" includes="${jaxws.runtime.xml}" prefix="WEB-INF"/>
         <zipfileset dir="${class.dir}" includes="${pkg.dir}/*.xml" prefix="WEB-INF/classes"/>
         <zipfileset dir="${src.dir}" includes="${pkg.dir}/*_handler*.xml" prefix="WEB-INF/classes"/>
    </ts.war>
    <var name="the.vehicle" value="endpoint"/>
    <removeSEIGSIsources/>
    <remove_webxml_file/>
    <remove_runtime_file/>

    <ts.ear archivename="${app.name}" descriptor="application.xml" includedefaultfiles="false">
         <zipfileset dir="${dist.dir}/${pkg.dir}" includes="${app.name}_web.war" />
    </ts.ear>
    <delete_generated_classes/>
  </target>


  <target name="client_import_package" >
    <determine.vehicles/>
    <property name="the.vehicles" value="${vehicles}"/>
    <antcall target="annotate_vehicles" />
    <antcall target="copy_client_dd_files" />

    <var name="tmpexcludefiles" value=" "/>
    <createstandalonevehicle/>
    <createwsejbvehicle/>
    <createwsappclientvehicle/>
    <createwsservletvehicle/>

    <remove_copied_wsdl_xsd/>
  </target>

  <macrodef name="createstandalonevehicle">
      <sequential>
        <!-- if standalone vehicle is enabled -->
        <var name="the.vehicle" value="standalone"/>
        <if>
           <contains substring="${the.vehicle}" string="${the.vehicles}"/>
        <then>
            <ts.vehicles name="${app.name}" vehicleoverride="standalone" includedefaultfiles="false"/>
        </then>
        </if>
      </sequential>
  </macrodef>

  <macrodef name="createwsejbvehicle">
      <sequential>
        <!-- if wsejb vehicle is enabled -->
        <var name="the.vehicle" value="wsejb"/>
        <if>
           <contains substring="${the.vehicle}" string="${the.vehicles}"/>
        <then>
            <createClientVehicleSEIGSI/>
            <ts.vehicles name="${app.name}" vehicleoverride="wsejb" includedefaultfiles="false">
                 <wsejb-elements>
                    <zipfileset dir="${class.dir}" includes="${common.classes}, 
                                                             ${portable.classes}, 
                                                             ${other.classes},
                                                             ${other.files}" 
                                                   excludes="${tmpexcludefiles}" />
                 </wsejb-elements>
            </ts.vehicles>
            <removeSEIGSIsources/>
        </then>
        </if>
      </sequential>
  </macrodef>

  <macrodef name="createwsservletvehicle">
      <sequential>
        <!-- if wsservlet vehicle is enabled -->
        <var name="the.vehicle" value="wsservlet"/>
        <if>
           <contains substring="${the.vehicle}" string="${the.vehicles}"/>
        <then>
            <createClientVehicleSEIGSI/>
            <ts.vehicles name="${app.name}" vehicleoverride="wsservlet" includedefaultfiles="false">
                 <wsservlet-elements>
                    <zipfileset dir="${class.dir}" includes="${common.classes}, 
                                                             ${portable.classes}, 
                                                             ${other.classes},
                                                             ${other.files}" 
                                                   excludes="${tmpexcludefiles}" prefix="WEB-INF/classes"/>
                 </wsservlet-elements>
            </ts.vehicles>
            <removeSEIGSIsources/>
        </then>
        </if>
      </sequential>
  </macrodef>

  <macrodef name="createwsappclientvehicle">
      <sequential>
        <!-- if wsappclient vehicle is enabled -->
        <var name="the.vehicle" value="wsappclient"/>
        <if>
           <contains substring="${the.vehicle}" string="${the.vehicles}"/>
        <then>
            <createClientVehicleSEIGSI/>
            <ts.vehicles name="${app.name}" vehicleoverride="wsappclient" includedefaultfiles="false">
                 <client-elements>
                    <zipfileset dir="${class.dir}" includes="${common.classes}, 
                                                             ${portable.classes}, 
                                                             ${other.classes},
                                                             ${other.files}" 
                                                   excludes="${tmpexcludefiles}" />
                    <zipfileset dir="${src.dir}/${pkg.dir}" includes="${wsdl.xsd.files}" prefix="META-INF/wsdl" />
                 </client-elements>
            </ts.vehicles>
            <removeSEIGSIsources/>
        </then>
        </if>
      </sequential>
  </macrodef>

  <target name="clean" unless="called.by.dosubdirs">
      <dosubdirs srcdir="${basedir}" todo="clean"/>
  </target>

</project>
